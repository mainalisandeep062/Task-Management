<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Task Manager Proactive UI</title>
    <style>
        :root { --primary: #007bff; --bg: #f8f9fa; --unread: #f0f7ff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; padding-top: 50px; }
        #app { background: white; width: 440px; padding: 25px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .hidden { display: none !important; }

        /* Login Components */
        .input-group { position: relative; margin-bottom: 15px; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .peak-btn { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; background: none; border: none; font-size: 18px; color: #666; width: auto; padding: 0; }
        button { width: 100%; padding: 12px; background: var(--primary); color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }

        /* Dashboard Header - Parallel Layout */
        .controls-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; background: #fff; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        .bell-box { position: relative; cursor: pointer; font-size: 32px; display: flex; align-items: center; }
        .badge { position: absolute; top: -5px; right: -5px; background: #ff4757; color: white; border-radius: 50%; padding: 2px 7px; font-size: 11px; border: 2px solid white; }

        .action-group { display: flex; gap: 12px; align-items: center; }
        .action-link { font-size: 13px; color: var(--primary); cursor: pointer; text-decoration: underline; font-weight: 500; }
        .refresh-btn { background: #eee; color: #333; padding: 5px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; cursor: pointer; border: 1px solid #ddd; }
        .refresh-btn:hover { background: #e2e2e2; }

        /* Notification Items */
        .notif-list { list-style: none; padding: 0; margin: 0; border: 1px solid #eee; border-radius: 8px; max-height: 350px; overflow-y: auto; }
        .notif-item { padding: 15px; border-bottom: 1px solid #f1f1f1; cursor: pointer; display: flex; flex-direction: column; }
        .unread { font-weight: bold; background: var(--unread); border-left: 5px solid var(--primary); }
        .read { font-weight: normal; background: #fff; border-left: 5px solid transparent; color: #777; }
        .time { font-size: 10px; color: #aaa; margin-top: 5px; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>

<div id="app">
    <div id="login-view">
        <h2 style="text-align:center">Account Login</h2>
        <div class="input-group"><input type="email" id="email" placeholder="Email" value="sandeep@yopmail.com"></div>
        <div class="input-group">
            <input type="password" id="password" placeholder="Password" value="password123">
            <button type="button" class="peak-btn" onclick="togglePassword()">üëÅÔ∏è</button>
        </div>
        <button onclick="handleLogin()">Sign In</button>
    </div>

    <div id="dashboard-view" class="hidden">
        <div class="controls-row">
            <div class="bell-box" onclick="toggleList()">
                üîî <span id="badge" class="badge">0</span>
            </div>
            <div class="action-group">
                <span class="refresh-btn" onclick="refreshDashboard()">üîÑ Refresh</span>
                <span class="action-link" onclick="markAllAsRead()">Mark all as read</span>
            </div>
        </div>

        <ul id="notif-list" class="notif-list hidden"></ul>
        <button style="margin-top:20px; background:#6c757d" onclick="location.reload()">Logout</button>
    </div>
</div>

<script>
    let token = null;
    let stompClient = null;
    let notifications = [];

    // --- NEW: Peek Password Feature ---
    function togglePassword() {
        const pw = document.getElementById('password');
        pw.type = pw.type === 'password' ? 'text' : 'password';
    }

    async function handleLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;
        const res = await fetch('http://localhost:8080/api/auth/login', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ email, password })
        });

        if (res.ok) {
            const data = await res.json();
            token = data.token || (data.body && data.body.token);
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('dashboard-view').classList.remove('hidden');
            initApp();
        }
    }

    // --- NEW: Refresh without Logout ---
    function refreshDashboard() {
        console.log("Refreshing dashboard data...");
        fetchInitialHistory(); // Simply re-fetch from API
    }

    function fetchInitialHistory() {
        fetch('http://localhost:8080/api/notification/my-notification', {
            headers: {'Authorization': `Bearer ${token}`}
        })
            .then(r => r.json())
            .then(d => {
                notifications = d.body || [];
                renderUI();
            });
    }

    function initApp() {
        fetchInitialHistory();

        const socket = new SockJS('http://localhost:8080/ws-notifications');
        stompClient = Stomp.over(socket);
        stompClient.connect({'Authorization': `Bearer ${token}`}, () => {

            // New Notifications
            stompClient.subscribe('/user/queue/notifications', (msg) => {
                const n = JSON.parse(msg.body).body || JSON.parse(msg.body);
                notifications.unshift(n);
                renderUI();
            });

            // Status Updates
            stompClient.subscribe('/user/queue/notifications/read-updates', (msg) => {
                let data;
                try { data = JSON.parse(msg.body); } catch(e) { data = msg.body; }
                const payload = data.body !== undefined ? data.body : data;

                if (payload === "ALL_READ") {
                    notifications.forEach(n => n.read = true);
                } else {
                    const idx = notifications.findIndex(x => x.id === payload.id);
                    if (idx !== -1) notifications[idx].read = true;
                }
                renderUI();
            });
        });
    }

    function markSingleRead(id) {
        fetch(`http://localhost:8080/api/notification/${id}/read`, {
            method: 'PATCH',
            headers: {'Authorization': `Bearer ${token}`}
        });
    }

    function markAllAsRead() {
        fetch('http://localhost:8080/api/notification', {
            method: 'PATCH',
            headers: {'Authorization': `Bearer ${token}`}
        });
    }

    function renderUI() {
        const container = document.getElementById('notif-list');
        const badge = document.getElementById('badge');

        notifications.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

        const unreadCount = notifications.filter(n => !n.read).length;
        badge.innerText = unreadCount;
        badge.style.display = unreadCount > 0 ? 'block' : 'none';

        container.innerHTML = "";
        notifications.forEach(n => {
            const li = document.createElement('li');
            li.className = `notif-item ${n.read ? 'read' : 'unread'}`;
            li.onclick = () => { if(!n.read) markSingleRead(n.id); };
            li.innerHTML = `
                <span>${n.title}</span>
                <span class="time">${new Date(n.createdAt).toLocaleTimeString()}</span>
            `;
            container.appendChild(li);
        });
    }

    function toggleList() { document.getElementById('notif-list').classList.toggle('hidden'); }
</script>
</body>
</html>