<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Task Manager - Notification Center</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f4f7f6; display: flex; flex-direction: column; align-items: center; padding: 50px; }
        .hidden { display: none !important; }
        #app-container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 400px; text-align: center; }

        /* Bell & Badge */
        .bell-container { position: relative; display: inline-block; cursor: pointer; margin-top: 20px; transition: transform 0.2s; }
        .bell-container:hover { transform: scale(1.1); }
        .bell-icon { font-size: 45px; }
        .badge {
            position: absolute; top: 0; right: 0;
            background: #ff4757; color: white; border-radius: 50%;
            padding: 4px 8px; font-size: 12px; font-weight: bold;
            border: 2px solid white;
        }

        /* Notification List */
        .notification-list {
            border: 1px solid #e0e0e0; margin-top: 15px; max-height: 250px; overflow-y: auto;
            text-align: left; list-style: none; padding: 0; border-radius: 4px; background: #fff;
        }
        .notification-item {
            padding: 12px; border-bottom: 1px solid #eee; font-size: 13px; color: #333;
            animation: slideIn 0.3s ease-out;
        }
        .notification-item:last-child { border-bottom: none; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* Layout */
        .input-group { margin-bottom: 15px; text-align: left; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }
        button:hover { background: #0056b3; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>
<body>

<div id="app-container">
    <div id="login-section">
        <h2>Task Login</h2>
        <div class="input-group">
            <input type="email" id="email" placeholder="Email (sandeep@yopmail.com)">
        </div>
        <div class="input-group">
            <input type="password" id="password" placeholder="Password">
        </div>
        <button onclick="handleLogin()">Sign In</button>
    </div>

    <div id="dashboard-section" class="hidden">
        <h2 id="greeting">Welcome!</h2>

        <div class="bell-container" onclick="toggleNotifications()">
            <span class="bell-icon">ðŸ””</span>
            <span id="notif-count" class="badge">0</span>
        </div>

        <ul id="notif-list" class="notification-list hidden">
        </ul>

        <button style="margin-top: 20px; background: #6c757d;" onclick="logout()">Logout</button>
    </div>
</div>

<script>
    let jwtToken = null;
    let stompClient = null;
    const BASE_URL = 'http://localhost:8080';

    async function handleLogin() {
        const email = document.getElementById('email').value;
        const password = document.getElementById('password').value;

        try {
            const response = await fetch(`${BASE_URL}/api/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });

            if (response.ok) {
                const data = await response.json();
                jwtToken = data.token;

                // 1. UI Transition
                document.getElementById('greeting').innerText = `Hello, ${email.split('@')[0]}!`;
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('dashboard-section').classList.remove('hidden');

                // 2. Data Initialization
                fetchUnreadCount();   // Use your count endpoint
                fetchUnreadHistory(); // Use your list endpoint
                connectWebSocket();   // Start live listener
            } else {
                alert("Invalid Credentials!");
            }
        } catch (error) {
            console.error("Login error:", error);
        }
    }

    // Uses your api/notification/unread-count endpoint
    function fetchUnreadCount() {
        fetch(`${BASE_URL}/api/notification/unread-count`, {
            headers: { 'Authorization': `Bearer ${jwtToken}` }
        })
            .then(res => res.json())
            .then(data => {
                // Mapping to your 'body' structure
                const count = (data.body !== undefined) ? data.body : 0;
                document.getElementById('notif-count').innerText = count;
            });
    }

    function fetchUnreadHistory() {
        fetch(`${BASE_URL}/api/notification/unread`, {
            headers: { 'Authorization': `Bearer ${jwtToken}` }
        })
            .then(res => res.json())
            .then(data => {
                const notifications = data.body || [];
                const list = document.getElementById('notif-list');
                list.innerHTML = ""; // Clear existing
                notifications.forEach(n => addNotificationToUI(n));
            });
    }

    function connectWebSocket() {
        // NOTE: Use absolute URL to avoid port confusion
        const socket = new SockJS(`${BASE_URL}/ws-notifications`);
        stompClient = Stomp.over(socket);

        // This header is sent during the CONNECT frame
        const headers = { 'Authorization': `Bearer ${jwtToken}` };

        stompClient.connect(headers, (frame) => {
            console.log('Connected to WebSocket');

            stompClient.subscribe('/user/queue/notifications', (message) => {
                const payload = JSON.parse(message.body);
                // Handle wrapped/unwrapped data
                const notification = payload.body ? payload.body : payload;

                // Update Badge
                const countBadge = document.getElementById('notif-count');
                countBadge.innerText = parseInt(countBadge.innerText) + 1;

                addNotificationToUI(notification);
            });
        }, (error) => {
            console.error('STOMP error:', error);
        });
    }

    function addNotificationToUI(notif) {
        const list = document.getElementById('notif-list');
        const item = document.createElement('li');
        item.className = 'notification-item';

        // Use 'title' based on your Swagger screenshot
        item.innerText = notif.title || notif.message || "New Task Update";

        list.prepend(item);
    }

    function toggleNotifications() {
        const list = document.getElementById('notif-list');
        list.classList.toggle('hidden');
    }

    function logout() { location.reload(); }
</script>
</body>
</html>